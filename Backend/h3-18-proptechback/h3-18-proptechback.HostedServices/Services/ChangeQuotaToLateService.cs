using h3_18_proptechback.Application.Contracts.Identity;
using h3_18_proptechback.Application.Contracts.Infrastructure.SendEmails;
using h3_18_proptechback.Application.Contracts.Persistence.Loan;
using h3_18_proptechback.Application.Contracts.Persistence.Quota;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

namespace h3_18_proptechback.HostedServices.Services
{
    internal class ChangeQuotaToLateService : IHostedService, IDisposable
    {
        private Timer _timer;
        private readonly IServiceProvider _serviceProvider;
        private IQuotaRepository _quotaRepository;
        private ILoanRepository _loanRepository;
        private IEmailServices _emailServices;
        private IUserIdentityService _userIdentityService;
        public ChangeQuotaToLateService(IServiceProvider serviceProvider)
        {
            _serviceProvider = serviceProvider;
        }
        public void Dispose()
        {
            _timer.Dispose();
        }

        public async void Handle(object state)
        {
            using var serviceScope = _serviceProvider.CreateScope();

            _quotaRepository = serviceScope.ServiceProvider.GetRequiredService<IQuotaRepository>();
            _loanRepository = serviceScope.ServiceProvider.GetRequiredService<ILoanRepository>();
            _emailServices = serviceScope.ServiceProvider.GetRequiredService<IEmailServices>();
            _userIdentityService = serviceScope.ServiceProvider.GetRequiredService<IUserIdentityService>();

            var loans = await _loanRepository.GetLoansQuotaPendingLate();

            foreach(var loan in loans)
            {
                loan.StateLoan = Domain.Common.StateLoan.Late;
                var user = await _userIdentityService.GetByIdIdentityUser(loan.Createby!);
                string fullName = string.Concat(user.Name, " ", user.LastName);
                foreach(var quota in loan.Quotas)
                {
                    quota.State = Domain.Common.StateQuota.Late;
                    decimal oldPrice = quota.Amount;
                    decimal newPrice = oldPrice + (oldPrice * 0.002m);
                    quota.Amount = newPrice;

                    await _quotaRepository.Update(quota);
                    await _emailServices.SendEmailAsync(new Application.Models.Emails.Email
                    {
                        TO = user.Email,
                        Subject = "¡Tu cuota ha vencido!",
                        Body = $"¡Tu cuota ha vencido!\r\n\r\nHola {fullName},\r\n\r\nQueremos informarte que la cuota número {quota.QuotaNumber} ha vencido el {quota.PayDate}.\r\n\r\nEl valor original de la cuota era ${oldPrice}. Sin embargo, debido a que ha pasado 1 día desde la fecha de vencimiento, se ha actualizado el precio de la cuota. El nuevo valor de la cuota es de ${newPrice}.\r\n\r\nDetalles del pago:\r\n- Numero del Préstamo: {loan.ID}\r\n- Numero de Cuota: {quota.QuotaNumber}\r\n- Precio original: ${oldPrice}\r\n- Fecha de Vencimiento: {quota.PayDate}\r\n- Nuevo Precio: ${newPrice}\r\n\r\n-------------------------------------------\r\n© {DateTime.UtcNow.Year} Nombre de la Empresa | Todos los derechos reservados",
                        BodyHTML = CreateBodyHtml(fullName, quota.QuotaNumber, oldPrice, newPrice, quota.PayDate, loan.ID)
                    });
                }
                await _loanRepository.Update(loan);
            }
            
        }

        public Task StartAsync(CancellationToken cancellationToken)
        {
            _timer = new Timer(Handle, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));
            return Task.CompletedTask;
        }

        public Task StopAsync(CancellationToken cancellationToken)
        {
            _timer?.Change(Timeout.Infinite, 0);

            return Task.CompletedTask;
        }

        private string CreateBodyHtml(string fullName, int quotaNumber, decimal price, decimal newPrice, DateTime expirationDate, Guid loanId)
        {
            return @$"<!DOCTYPE html>
<html lang=""es"">
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <title>Notificación de Pago</title>
    <style>
        body {{
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
        }}
        .email-container {{
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }}
        .header {{
            background-color: white;
            padding: 20px;
            text-align: center;
        }}
        .header img {{
            max-width: 130px;
        }}
        .card-content {{
            padding: 20px;
            color: #333;
        }}
        .card-content h2 {{
            color: #3d5a80;
            margin-bottom: 10px;
        }}
        .card-content p {{
            font-size: 16px;
            line-height: 1.5;
            margin: 10px 0;
        }}
        .card-content .payment-info {{
            margin-top: 20px;
            background-color: #f0f4f8;
            padding: 15px;
            border-radius: 6px;
        }}
        .card-content .payment-info p {{
            margin: 5px 0;
        }}
        .footer {{
            background-color: #3d5a80;
            color: white;
            padding: 10px;
            text-align: center;
        }}
    </style>
</head>
<body>

    <div class=""email-container"" style=""margin-top: 2em;"">
        <div class=""header"">
            <!-- Logo -->
            <svg width=""130"" height=""119"" viewBox=""0 0 130 119"" fill=""none"" xmlns=""http://www.w3.org/2000/svg"">
                <mask id=""mask0_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""14"" y=""57"" width=""104"" height=""33"">
                <path d=""M14.7109 57.4575H117.005V89.2941H14.7109V57.4575Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask0_624_1925)"">
                <mask id=""mask1_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""14"" y=""36"" width=""105"" height=""74"">
                <path d=""M26.2236 36.1533L118.559 57.3029L106.673 109.194L14.3379 88.0447L26.2236 36.1533Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask1_624_1925)"">
                <mask id=""mask2_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""14"" y=""36"" width=""105"" height=""74"">
                <path d=""M26.2236 36.1533L118.559 57.3029L106.673 109.194L14.3379 88.0447L26.2236 36.1533Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask2_624_1925)"">
                <path d=""M17.202 88.8174L36.4902 78.0062L39.7929 83.2436C40.1069 83.7431 40.6023 84.0917 41.1793 84.2201C41.7542 84.3486 42.3515 84.2446 42.849 83.9266L59.1974 73.4924L63.5603 80.0653C64.2188 81.0581 65.5439 81.3476 66.5592 80.7217L84.873 69.4109L89.9779 76.1C90.6772 77.0153 91.9697 77.2396 92.9361 76.6117L116.628 61.2194L114.222 57.5171L92.247 71.7942L87.1706 65.1419C86.4835 64.2428 85.2195 64.0084 84.2552 64.6037L66.0577 75.8431L61.6765 69.2438C61.0098 68.2387 59.6663 67.9553 58.651 68.6036L42.3434 79.0112L39.1059 73.8778C38.482 72.8869 37.1834 72.5567 36.16 73.1296L15.043 84.9663L17.202 88.8174Z"" fill=""#3D5A80""/>
                </g>
                </g>
                </g>
                <mask id=""mask3_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""104"" y=""54"" width=""15"" height=""16"">
                <path d=""M104.479 54.3262H118.57V69.4616H104.479V54.3262Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask3_624_1925)"">
                <mask id=""mask4_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""14"" y=""36"" width=""105"" height=""74"">
                <path d=""M26.2216 36.1533L118.557 57.3029L106.671 109.194L14.3359 88.0447L26.2216 36.1533Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask4_624_1925)"">
                <mask id=""mask5_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""14"" y=""36"" width=""105"" height=""74"">
                <path d=""M26.2216 36.1533L118.557 57.3029L106.671 109.194L14.3359 88.0447L26.2216 36.1533Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask5_624_1925)"">
                <path d=""M104.883 58.7056L113.384 60.6525L111.684 68.0775L115.988 69.0622L118.181 59.4864C118.31 58.9196 118.208 58.3141 117.9 57.8208C117.59 57.3294 117.089 56.9727 116.522 56.8422L105.87 54.4019L104.883 58.7056Z"" fill=""#3D5A80""/>
                </g>
                </g>
                </g>
                <mask id=""mask6_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""12"" y=""9"" width=""101"" height=""69"">
                <path d=""M12.623 9.44189H112.83V77.8122H12.623V9.44189Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask6_624_1925)"">
                <mask id=""mask7_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""-1"" y=""-4"" width=""115"" height=""83"">
                <path d=""M-0.0136719 26.7281L97.2411 -3.25928L113.157 48.3609L15.9026 78.3463L-0.0136719 26.7281Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask7_624_1925)"">
                <mask id=""mask8_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""-1"" y=""-4"" width=""115"" height=""83"">
                <path d=""M-0.0136719 26.7281L97.2411 -3.25928L113.157 48.3609L15.9026 78.3463L-0.0136719 26.7281Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask8_624_1925)"">
                <path d=""M110.338 49.1296C110.15 49.1887 109.957 49.2275 109.761 49.2479C109.563 49.2682 109.368 49.2682 109.17 49.2499C108.974 49.2315 108.78 49.1948 108.591 49.1378C108.401 49.0807 108.22 49.0073 108.044 48.9155C107.869 48.8218 107.706 48.7137 107.551 48.5894C107.398 48.465 107.258 48.3264 107.133 48.1735C107.007 48.0226 106.897 47.8595 106.801 47.6862C106.707 47.5109 106.632 47.3294 106.573 47.1419C99.28 23.4867 74.1081 10.18 50.461 17.4725C26.814 24.7629 13.4992 49.9349 20.7916 73.5901C20.8548 73.7797 20.8997 73.9754 20.9221 74.1732C20.9466 74.373 20.9506 74.5727 20.9364 74.7725C20.9201 74.9723 20.8854 75.1681 20.8304 75.3617C20.7753 75.5534 20.7019 75.7389 20.6102 75.9183C20.5184 76.0957 20.4104 76.2628 20.284 76.4198C20.1596 76.5768 20.019 76.7195 19.8661 76.8479C19.7111 76.9764 19.546 77.0885 19.3706 77.1843C19.1953 77.2802 19.0098 77.3576 18.8182 77.4167C18.6265 77.4759 18.4328 77.5146 18.233 77.535C18.0332 77.5554 17.8335 77.5554 17.6337 77.537C17.4339 77.5166 17.2382 77.4779 17.0465 77.4188C16.8549 77.3597 16.6714 77.2822 16.4961 77.1864C16.3187 77.0906 16.1536 76.9784 16.0007 76.85C15.8457 76.7215 15.7071 76.5788 15.5807 76.4239C15.4543 76.2669 15.3462 76.0997 15.2545 75.9224C15.1627 75.743 15.0893 75.5574 15.0323 75.3658C6.7612 48.5404 21.8599 19.9842 48.6853 11.7131C75.5107 3.44205 104.067 18.5387 112.338 45.3641C112.395 45.5537 112.436 45.7474 112.454 45.9431C112.475 46.1409 112.477 46.3366 112.456 46.5343C112.438 46.7321 112.401 46.9258 112.344 47.1154C112.287 47.305 112.212 47.4864 112.118 47.6617C112.026 47.8371 111.916 48.0002 111.792 48.1531C111.667 48.308 111.527 48.4466 111.376 48.573C111.223 48.6994 111.058 48.8095 110.884 48.9033C110.709 48.9971 110.528 49.0725 110.338 49.1296Z"" fill=""#EC8B57""/>
                </g>
                </g>
                </g>
                <mask id=""mask9_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""40"" y=""45"" width=""8"" height=""28"">
                <path d=""M40.8984 45.1133H47.8566V72.1323H40.8984V45.1133Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask9_624_1925)"">
                <mask id=""mask10_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""40"" y=""45"" width=""8"" height=""28"">
                <path d=""M42.4642 45.1133H46.2908C47.1573 45.1133 47.8566 45.8126 47.8566 46.679V70.5666C47.8566 71.431 47.1573 72.1323 46.2908 72.1323H42.4642C41.5998 72.1323 40.8984 71.431 40.8984 70.5666V46.679C40.8984 45.8126 41.5998 45.1133 42.4642 45.1133Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask10_624_1925)"">
                <path d=""M40.8984 45.1133H47.8566V72.1323H40.8984V45.1133Z"" fill=""#3D5A80""/>
                </g>
                </g>
                <mask id=""mask11_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""25"" y=""53"" width=""8"" height=""20"">
                <path d=""M25.4473 53.5596H32.4074V72.75H25.4473V53.5596Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask11_624_1925)"">
                <mask id=""mask12_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""25"" y=""53"" width=""8"" height=""20"">
                <path d=""M27.013 53.5596H30.8417C31.7061 53.5596 32.4074 54.2609 32.4074 55.1253V71.1802C32.4074 72.0446 31.7061 72.7459 30.8417 72.7459H27.013C26.1486 72.7459 25.4473 72.0446 25.4473 71.1802V55.1253C25.4473 54.2609 26.1486 53.5596 27.013 53.5596Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask12_624_1925)"">
                <path d=""M25.4473 53.5596H32.4074V72.75H25.4473V53.5596Z"" fill=""#3D5A80""/>
                </g>
                </g>
                <mask id=""mask13_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""56"" y=""36"" width=""8"" height=""30"">
                <path d=""M56.2637 36.4956H63.2218V65.2007H56.2637V36.4956Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask13_624_1925)"">
                <mask id=""mask14_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""56"" y=""36"" width=""8"" height=""30"">
                <path d=""M57.8294 36.4956H61.6561C62.5205 36.4956 63.2218 37.1969 63.2218 38.0613V63.6207C63.2218 64.4851 62.5205 65.1864 61.6561 65.1864H57.8294C56.963 65.1864 56.2637 64.4851 56.2637 63.6207V38.0613C56.2637 37.1969 56.963 36.4956 57.8294 36.4956Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask14_624_1925)"">
                <path d=""M56.2637 36.4956H63.2218V65.1721H56.2637V36.4956Z"" fill=""#3D5A80""/>
                </g>
                </g>
                <mask id=""mask15_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""70"" y=""30"" width=""8"" height=""38"">
                <path d=""M70.4629 30.3774H77.4231V67.5636H70.4629V30.3774Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask15_624_1925)"">
                <mask id=""mask16_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""70"" y=""30"" width=""8"" height=""38"">
                <path d=""M72.0286 30.3774H75.8573C76.7217 30.3774 77.4231 31.0788 77.4231 31.9432V65.9815C77.4231 66.8459 76.7217 67.5473 75.8573 67.5473H72.0286C71.1642 67.5473 70.4629 66.8459 70.4629 65.9815V31.9432C70.4629 31.0788 71.1642 30.3774 72.0286 30.3774Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask16_624_1925)"">
                <path d=""M70.4629 30.3774H77.4231V67.5371H70.4629V30.3774Z"" fill=""#3D5A80""/>
                </g>
                </g>
                <mask id=""mask17_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""85"" y=""28"" width=""8"" height=""34"">
                <path d=""M85.252 28.7915H92.2121V61.4374H85.252V28.7915Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask17_624_1925)"">
                <mask id=""mask18_624_1925"" style=""mask-type:luminance"" maskUnits=""userSpaceOnUse"" x=""85"" y=""28"" width=""8"" height=""34"">
                <path d=""M86.8177 28.7915H90.6464C91.5108 28.7915 92.2121 29.4928 92.2121 30.3572V59.8676C92.2121 60.732 91.5108 61.4333 90.6464 61.4333H86.8177C85.9533 61.4333 85.252 60.732 85.252 59.8676V30.3572C85.252 29.4928 85.9533 28.7915 86.8177 28.7915Z"" fill=""white""/>
                </mask>
                <g mask=""url(#mask18_624_1925)"">
                <path d=""M85.252 28.7915H92.2121V61.4374H85.252V28.7915Z"" fill=""#3D5A80""/>
                </g>
                </g>
                <path d=""M20.8754 103.873C20.4616 103.873 20.1374 103.758 19.905 103.53C19.6767 103.298 19.5625 102.963 19.5625 102.527V91.0858C19.5625 90.6515 19.6767 90.3192 19.905 90.0909C20.1374 89.8585 20.4718 89.7402 20.9081 89.7402H27.8315C28.174 89.7402 28.4289 89.8279 28.5981 90.0012C28.7714 90.1704 28.859 90.415 28.859 90.7351C28.859 91.0613 28.7714 91.3141 28.5981 91.4935C28.4289 91.6729 28.174 91.7626 27.8315 91.7626H22.0987V95.7096H27.4156C27.7459 95.7096 27.9987 95.7973 28.174 95.9705C28.3534 96.1398 28.4431 96.3824 28.4431 96.6963C28.4431 97.0286 28.3534 97.2835 28.174 97.4629C27.9987 97.6423 27.7459 97.732 27.4156 97.732H22.0987V102.527C22.0987 103.424 21.6909 103.873 20.8754 103.873Z"" fill=""#1E1E1E""/>
                <path d=""M31.6983 103.856C31.3008 103.856 30.997 103.738 30.785 103.505C30.573 103.267 30.467 102.934 30.467 102.51V95.2363C30.467 94.7959 30.573 94.4616 30.785 94.2332C30.997 94.0008 31.3008 93.8826 31.6983 93.8826C32.0939 93.8826 32.4017 94.0008 32.6198 94.2332C32.8359 94.4616 32.946 94.7959 32.946 95.2363V102.51C32.946 102.934 32.84 103.267 32.628 103.505C32.416 103.738 32.1061 103.856 31.6983 103.856ZM31.6983 92.0396C31.2356 92.0396 30.8747 91.9254 30.6137 91.6971C30.3569 91.4647 30.2305 91.1425 30.2305 90.7348C30.2305 90.3108 30.3569 89.9886 30.6137 89.7644C30.8747 89.536 31.2356 89.4219 31.6983 89.4219C32.1713 89.4219 32.5322 89.536 32.7829 89.7644C33.0378 89.9886 33.1662 90.3108 33.1662 90.7348C33.1662 91.1425 33.0378 91.4647 32.7829 91.6971C32.5322 91.9254 32.1713 92.0396 31.6983 92.0396Z"" fill=""#1E1E1E""/>
                <path d=""M36.7529 103.872C36.3553 103.872 36.0515 103.762 35.8395 103.546C35.6275 103.33 35.5215 103.016 35.5215 102.608V95.1142C35.5215 94.7064 35.6275 94.3965 35.8395 94.1845C36.0515 93.9725 36.3472 93.8665 36.7284 93.8665C37.1137 93.8665 37.4134 93.9725 37.6254 94.1845C37.8375 94.3965 37.9435 94.7064 37.9435 95.1142V96.4597L37.7233 95.9623C38.0108 95.2671 38.4613 94.737 39.077 94.3721C39.6907 94.0092 40.3899 93.8257 41.1728 93.8257C41.9495 93.8257 42.5877 93.9725 43.0892 94.266C43.5948 94.5555 43.9719 94.9918 44.2227 95.579C44.4714 96.1661 44.5978 96.9123 44.5978 97.8134V102.608C44.5978 103.016 44.4918 103.33 44.2798 103.546C44.0718 103.762 43.7701 103.872 43.3746 103.872C42.9771 103.872 42.6692 103.762 42.4531 103.546C42.235 103.33 42.1269 103.016 42.1269 102.608V97.9276C42.1269 97.1773 41.9822 96.631 41.6947 96.2884C41.4113 95.9419 40.973 95.7665 40.3818 95.7665C39.6519 95.7665 39.0729 95.9949 38.6448 96.4515C38.2146 96.9082 38.0006 97.5117 38.0006 98.2619V102.608C38.0006 103.452 37.5847 103.872 36.7529 103.872Z"" fill=""#1E1E1E""/>
                <path d=""M50.3063 103.913C49.6091 103.913 48.9873 103.779 48.4388 103.514C47.8884 103.242 47.4603 102.876 47.1504 102.413C46.8405 101.946 46.6855 101.424 46.6855 100.847C46.6855 100.129 46.869 99.5647 47.2401 99.1508C47.6091 98.7329 48.2105 98.4311 49.0423 98.2456C49.8741 98.0621 50.9913 97.9683 52.3939 97.9683H53.3807V99.3954H52.4103C51.5887 99.3954 50.9342 99.4362 50.4449 99.5178C49.9556 99.5952 49.607 99.7298 49.4011 99.9255C49.1993 100.117 49.0994 100.382 49.0994 100.725C49.0994 101.161 49.2502 101.516 49.5561 101.793C49.8598 102.07 50.2839 102.209 50.8282 102.209C51.2625 102.209 51.6478 102.109 51.9862 101.907C52.3226 101.701 52.5897 101.422 52.7854 101.067C52.9852 100.708 53.0871 100.299 53.0871 99.8358V97.5525C53.0871 96.8899 52.9403 96.4148 52.6467 96.1254C52.3572 95.8318 51.868 95.685 51.1789 95.685C50.7976 95.685 50.3838 95.7319 49.9393 95.8236C49.499 95.9174 49.0341 96.0764 48.5449 96.3048C48.2941 96.425 48.0719 96.4577 47.8762 96.4026C47.6845 96.3496 47.5357 96.2395 47.4276 96.0764C47.3237 95.9092 47.2727 95.7258 47.2727 95.53C47.2727 95.3343 47.3237 95.1427 47.4276 94.9511C47.5357 94.7553 47.7171 94.6126 47.974 94.5188C48.5775 94.2701 49.1585 94.0928 49.7192 93.9888C50.2839 93.8807 50.7976 93.8257 51.2604 93.8257C52.2105 93.8257 52.9933 93.9725 53.609 94.266C54.2227 94.5555 54.6814 94.9918 54.9872 95.579C55.291 96.1661 55.4439 96.9225 55.4439 97.846V102.608C55.4439 103.016 55.3419 103.33 55.1421 103.546C54.9464 103.762 54.663 103.872 54.294 103.872C53.923 103.872 53.6355 103.762 53.4296 103.546C53.2278 103.33 53.1279 103.016 53.1279 102.608V101.654H53.2828C53.189 102.117 53.0076 102.517 52.7364 102.853C52.4633 103.192 52.1248 103.452 51.7171 103.636C51.3093 103.819 50.8384 103.913 50.3063 103.913Z"" fill=""#1E1E1E""/>
                <path d=""M59.1923 103.872C58.7948 103.872 58.491 103.762 58.279 103.546C58.067 103.33 57.9609 103.016 57.9609 102.608V95.1142C57.9609 94.7064 58.067 94.3965 58.279 94.1845C58.491 93.9725 58.7866 93.8665 59.1679 93.8665C59.5532 93.8665 59.8529 93.9725 60.0649 94.1845C60.2769 94.3965 60.3829 94.7064 60.3829 95.1142V96.4597L60.1627 95.9623C60.4502 95.2671 60.9008 94.737 61.5165 94.3721C62.1301 94.0092 62.8294 93.8257 63.6122 93.8257C64.389 93.8257 65.0271 93.9725 65.5286 94.266C66.0342 94.5555 66.4114 94.9918 66.6622 95.579C66.9109 96.1661 67.0373 96.9123 67.0373 97.8134V102.608C67.0373 103.016 66.9313 103.33 66.7192 103.546C66.5113 103.762 66.2096 103.872 65.8141 103.872C65.4165 103.872 65.1087 103.762 64.8926 103.546C64.6744 103.33 64.5664 103.016 64.5664 102.608V97.9276C64.5664 97.1773 64.4216 96.631 64.1342 96.2884C63.8508 95.9419 63.4125 95.7665 62.8212 95.7665C62.0914 95.7665 61.5124 95.9949 61.0842 96.4515C60.6541 96.9082 60.44 97.5117 60.44 98.2619V102.608C60.44 103.452 60.0241 103.872 59.1923 103.872Z"" fill=""#1E1E1E""/>
                <path d=""M74.0328 103.913C73.0155 103.913 72.1287 103.707 71.3743 103.293C70.6241 102.876 70.041 102.282 69.6292 101.516C69.2214 100.749 69.0176 99.8521 69.0176 98.8246C69.0176 98.0417 69.1317 97.3445 69.3601 96.7288C69.5925 96.1152 69.9268 95.5932 70.3631 95.1631C70.8035 94.7349 71.3336 94.4047 71.9533 94.1763C72.5731 93.9439 73.2663 93.8257 74.0328 93.8257C74.4732 93.8257 74.9462 93.8868 75.4518 94.0051C75.9614 94.1254 76.4405 94.3231 76.887 94.6004C77.099 94.7309 77.2377 94.8899 77.3029 95.0734C77.3722 95.2589 77.3865 95.4485 77.3437 95.6442C77.3049 95.8359 77.2234 96.001 77.099 96.1417C76.9726 96.2783 76.8177 96.3618 76.6342 96.3945C76.4487 96.4271 76.2448 96.3843 76.0226 96.264C75.729 96.0907 75.4293 95.9623 75.1256 95.8807C74.8198 95.7951 74.5303 95.7502 74.253 95.7502C73.8167 95.7502 73.4334 95.8216 73.1032 95.9623C72.7708 96.0988 72.4875 96.2966 72.2551 96.5576C72.0267 96.8144 71.8514 97.1345 71.7331 97.5198C71.619 97.9011 71.5619 98.3414 71.5619 98.8409C71.5619 99.8195 71.7943 100.592 72.2632 101.157C72.7301 101.718 73.3927 101.997 74.253 101.997C74.5303 101.997 74.8177 101.956 75.1174 101.875C75.4151 101.793 75.7168 101.669 76.0226 101.499C76.2448 101.381 76.4426 101.34 76.6179 101.377C76.7973 101.416 76.9461 101.506 77.0664 101.646C77.1847 101.783 77.2581 101.948 77.2866 102.144C77.3131 102.335 77.2886 102.523 77.2132 102.706C77.1418 102.892 77.0093 103.045 76.8136 103.163C76.3773 103.43 75.9166 103.62 75.4273 103.734C74.938 103.852 74.4732 103.913 74.0328 103.913Z"" fill=""#1E1E1E""/>
                <path d=""M80.1437 103.856C79.7461 103.856 79.4423 103.738 79.2303 103.505C79.0183 103.267 78.9123 102.934 78.9123 102.51V95.2363C78.9123 94.7959 79.0183 94.4616 79.2303 94.2332C79.4423 94.0008 79.7461 93.8826 80.1437 93.8826C80.5392 93.8826 80.847 94.0008 81.0652 94.2332C81.2813 94.4616 81.3913 94.7959 81.3913 95.2363V102.51C81.3913 102.934 81.2853 103.267 81.0733 103.505C80.8613 103.738 80.5514 103.856 80.1437 103.856ZM80.1437 92.0396C79.6809 92.0396 79.32 91.9254 79.0591 91.6971C78.8022 91.4647 78.6758 91.1425 78.6758 90.7348C78.6758 90.3108 78.8022 89.9886 79.0591 89.7644C79.32 89.536 79.6809 89.4219 80.1437 89.4219C80.6166 89.4219 80.9775 89.536 81.2282 89.7644C81.4831 89.9886 81.6115 90.3108 81.6115 90.7348C81.6115 91.1425 81.4831 91.4647 81.2282 91.6971C80.9775 91.9254 80.6166 92.0396 80.1437 92.0396Z"" fill=""#1E1E1E""/>
                <path d=""M87.1559 103.913C86.4587 103.913 85.8369 103.779 85.2884 103.514C84.738 103.242 84.3099 102.876 84 102.413C83.6901 101.946 83.5352 101.424 83.5352 100.847C83.5352 100.129 83.7186 99.5647 84.0897 99.1508C84.4587 98.7329 85.0601 98.4311 85.8919 98.2456C86.7237 98.0621 87.8409 97.9683 89.2436 97.9683H90.2303V99.3954H89.2599C88.4383 99.3954 87.7838 99.4362 87.2945 99.5178C86.8053 99.5952 86.4566 99.7298 86.2507 99.9255C86.0489 100.117 85.949 100.382 85.949 100.725C85.949 101.161 86.0999 101.516 86.4057 101.793C86.7094 102.07 87.1335 102.209 87.6778 102.209C88.1121 102.209 88.4974 102.109 88.8358 101.907C89.1722 101.701 89.4393 101.422 89.635 101.067C89.8348 100.708 89.9367 100.299 89.9367 99.8358V97.5525C89.9367 96.8899 89.7899 96.4148 89.4964 96.1254C89.2069 95.8318 88.7176 95.685 88.0285 95.685C87.6472 95.685 87.2334 95.7319 86.7889 95.8236C86.3486 95.9174 85.8838 96.0764 85.3945 96.3048C85.1437 96.425 84.9215 96.4577 84.7258 96.4026C84.5341 96.3496 84.3853 96.2395 84.2772 96.0764C84.1733 95.9092 84.1223 95.7258 84.1223 95.53C84.1223 95.3343 84.1733 95.1427 84.2772 94.9511C84.3853 94.7553 84.5667 94.6126 84.8236 94.5188C85.4271 94.2701 86.0081 94.0928 86.5688 93.9888C87.1335 93.8807 87.6472 93.8257 88.11 93.8257C89.0601 93.8257 89.8429 93.9725 90.4586 94.266C91.0723 94.5555 91.531 94.9918 91.8368 95.579C92.1406 96.1661 92.2935 96.9225 92.2935 97.846V102.608C92.2935 103.016 92.1915 103.33 91.9917 103.546C91.796 103.762 91.5126 103.872 91.1436 103.872C90.7726 103.872 90.4851 103.762 90.2792 103.546C90.0774 103.33 89.9775 103.016 89.9775 102.608V101.654H90.1324C90.0387 102.117 89.8572 102.517 89.5861 102.853C89.3129 103.192 88.9744 103.452 88.5667 103.636C88.159 103.819 87.688 103.913 87.1559 103.913Z"" fill=""#1E1E1E""/>
                <path d=""M95.9998 103.815C95.5472 103.815 95.1864 103.677 94.9152 103.399C94.6481 103.122 94.5156 102.767 94.5156 102.331C94.5156 101.907 94.6481 101.56 94.9152 101.287C95.1864 101.016 95.5472 100.879 95.9998 100.879C96.4606 100.879 96.8194 101.016 97.0762 101.287C97.3372 101.56 97.4677 101.907 97.4677 102.331C97.4677 102.767 97.3372 103.122 97.0762 103.399C96.8194 103.677 96.4606 103.815 95.9998 103.815Z"" fill=""#1E1E1E""/>
                <path d=""M102.914 104.088C102.216 104.088 101.595 103.953 101.046 103.688C100.496 103.417 100.068 103.05 99.7578 102.587C99.4479 102.12 99.293 101.598 99.293 101.021C99.293 100.304 99.4765 99.739 99.8475 99.3251C100.217 98.9072 100.818 98.6055 101.65 98.4199C102.482 98.2364 103.599 98.1427 105.001 98.1427H105.988V99.5698H105.018C104.196 99.5698 103.542 99.6105 103.052 99.6921C102.563 99.7696 102.214 99.9041 102.009 100.1C101.807 100.291 101.707 100.557 101.707 100.899C101.707 101.335 101.858 101.69 102.163 101.967C102.467 102.245 102.891 102.383 103.436 102.383C103.87 102.383 104.255 102.283 104.594 102.081C104.93 101.876 105.197 101.596 105.393 101.242C105.593 100.883 105.695 100.473 105.695 100.01V97.7268C105.695 97.0642 105.548 96.5892 105.254 96.2997C104.965 96.0061 104.475 95.8593 103.786 95.8593C103.405 95.8593 102.991 95.9062 102.547 95.9979C102.106 96.0917 101.642 96.2507 101.152 96.4791C100.902 96.5994 100.679 96.632 100.484 96.5769C100.292 96.5239 100.143 96.4138 100.035 96.2507C99.9311 96.0836 99.8801 95.9001 99.8801 95.7044C99.8801 95.5086 99.9311 95.317 100.035 95.1254C100.143 94.9297 100.325 94.7869 100.581 94.6932C101.185 94.4444 101.766 94.2671 102.327 94.1631C102.891 94.055 103.405 94 103.868 94C104.818 94 105.601 94.1468 106.216 94.4404C106.83 94.7299 107.289 95.1661 107.595 95.7533C107.898 96.3404 108.051 97.0968 108.051 98.0203V102.783C108.051 103.191 107.949 103.504 107.75 103.721C107.554 103.937 107.27 104.047 106.901 104.047C106.53 104.047 106.243 103.937 106.037 103.721C105.835 103.504 105.735 103.191 105.735 102.783V101.829H105.89C105.796 102.291 105.615 102.691 105.344 103.027C105.071 103.366 104.732 103.627 104.325 103.81C103.917 103.994 103.446 104.088 102.914 104.088Z"" fill=""#1E1E1E""/>
                <path d=""M113.427 104.13C112.334 104.13 111.512 103.823 110.956 103.206C110.395 102.592 110.119 101.678 110.119 100.47V91.2262C110.119 90.8254 110.224 90.5235 110.442 90.3207C110.656 90.1085 110.96 90 111.355 90C111.745 90 112.049 90.1085 112.267 90.3207C112.481 90.5235 112.591 90.8254 112.591 91.2262V100.357C112.591 100.961 112.714 101.409 112.971 101.696C113.223 101.989 113.589 102.13 114.074 102.13C114.173 102.13 114.268 102.13 114.359 102.13C114.458 102.121 114.554 102.102 114.644 102.074C114.82 102.05 114.939 102.102 115.005 102.225C115.081 102.352 115.119 102.602 115.119 102.979C115.119 103.309 115.048 103.564 114.91 103.753C114.782 103.932 114.568 104.036 114.264 104.073C114.135 104.083 113.997 104.097 113.845 104.111C113.703 104.121 113.565 104.13 113.427 104.13Z"" fill=""#1E1E1E""/>
                </svg>
        </div>

        <div class=""card-content"">
            <h2>¡Tu cuota ha vencido!</h2>
            <p>Hola {fullName},</p>
            <p>Queremos informarte que la cuota número <strong>{quotaNumber}</strong> ha vencido el <strong>{expirationDate}</strong>.</p>
            <p>El valor original de la cuota era <strong>${{price}}</strong>, sin embargo, debido a que ha pasado 1 díoa desde la fecha de vencimiento, se ha actualizado el precio de la cuota. El nuevo valor de la cuota es de <strong>${newPrice}</strong>.</p>
            <div class=""payment-info"">
                <p><strong>Numero del Prestamo:</strong> {loanId}</p>
                <p><strong>Numero de Cuota:</strong> {quotaNumber}</p>
                <p><strong>Precio original:</strong> ${price}</p>
                <p><strong>Fecha de Vencimiento:</strong> {expirationDate}</p>
                <p><strong>Nuevo Precio:</strong> {newPrice}</p>
            </div>
        </div>

        <div class=""footer"">
            <p>&copy; {DateTime.UtcNow.Year} Financia.al | Todos los derechos reservados</p>
        </div>
    </div>

</body>
</html>";
        }
    }
}
